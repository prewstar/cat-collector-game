<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Cat Collector's Quest</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3e8ff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
            box-sizing: border-box;
        }

        .game-container {
            max-width: 800px;
            width: 100%;
            background-color: #ffffff;
            border-radius: 2rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            padding: 2.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .story-text {
            line-height: 1.75;
            color: #4a5568;
        }

        .button-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        button {
            background-color: #8b5cf6;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: bold;
            transition: transform 0.2s, background-color 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            border: none;
            text-align: left;
        }

        button:hover {
            background-color: #7c3aed;
            transform: translateY(-2px);
        }

        .fade-in {
            animation: fadeIn 0.8s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .restart-button {
            background-color: #ef4444;
        }

        .undo-button {
            background-color: #f59e0b;
        }

        .secret-ending-button {
            background-color: #22c55e;
        }
        
        /* Modal for images and hints */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 1rem;
            max-width: 90%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
            white-space: pre-wrap; /* Preserve whitespace for hints */
        }
        .modal-content img {
            max-width: 100%;
            height: auto;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
        }
        .modal-content .close-button {
            background-color: #8b5cf6;
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: bold;
            cursor: pointer;
        }
        .inventory-item {
            border: 1px solid #d1d5db;
            padding: 0.5rem;
            border-radius: 0.5rem;
            background-color: #f9fafb;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="game-container">
        <h1 class="text-3xl font-bold text-center text-gray-800">The Cat Collector's Quest</h1>
        <div id="game-info" class="text-center text-sm text-gray-500 flex justify-between px-4">
            <span id="cats-collected">Cats Collected: 0</span>
            <span id="special-cats-collected">Special Cats: 0</span>
            <span id="story-fails">Fails: 0</span>
            <button id="hint-button" class="bg-gray-400 text-white text-xs px-2 py-1 rounded-full hover:bg-gray-500">Hint</button>
        </div>
        <div id="special-cats-names" class="mt-4 text-sm text-gray-600 flex justify-center space-x-2"></div>
        <div id="inventory-container" class="mt-4 text-sm text-gray-600 flex justify-center space-x-2">
            <span id="item-rod" class="hidden inventory-item">üé£ Lucky Rod</span>
            <span id="item-persian" class="hidden inventory-item">üëë Pampered Persian</span>
            <span id="item-crystal" class="hidden inventory-item">üíé Glowing Crystal</span>
            <span id="item-exotic" class="hidden inventory-item">üêØ Exotic Cat</span>
        </div>
        <div id="story-text" class="story-text text-lg"></div>
        <div id="choice-buttons" class="button-container"></div>
    </div>
    
    <!-- Image/Hint Modal -->
    <div id="image-modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title" class="text-2xl font-bold mb-4"></h2>
            <img id="modal-image" src="" alt="">
            <p id="modal-text" class="mb-4"></p>
            <button id="modal-continue-button" class="close-button">Continue</button>
        </div>
    </div>

    <script>
        // Use a self-invoking anonymous function to avoid polluting the global scope
        (function() {
            // --- Image URLs have been removed to prevent local file errors ---
            const imageUrls = {
                aquatic: "images/aquatic.png",
                sphinx: "images/sphinx.png",
                tiger: "images/tiger.png",
                lynx: "images/lynx.png",
                ethereal: "images/ethereal.png",
                glowingCrystal: null
            };
            
            const hintData = {
                aquatic: "1. The farmer is struggling with mice, help him out and he'll give you a special reward.",
                sphinx: "2. Rumours are sometimes true.",
                tiger: "3. Did you ever think of entering your own exotic cat in the Pawsh Show?",
                lynx: "4. A patient cat awaits in the desert if you have a certain fluffy friend with you.",
                ethereal: "5. An ancient cat is hidden in a deep cave, but you need a special crystal to find it."
            };

            // --- Game State Variables ---
            let currentState = 'start';
            let previousState = '';
            let catsCollected = 0;
            let storyFails = 0;
            const totalCats = 15;
            let hasDesertLynx = false;
            let hasExoticCat = false;
            let hasVisitedSeaside = false;
            let hasVisitedForest = false;
            let hasVisitedDesert = false;
            let hasCafeClue = false;
            let hasLuckyRod = false;
            let hasPamperedPersian = false;
            let hasGlowingCrystal = false;
            let specialCats = {
                aquatic: false,
                sphinx: false,
                tiger: false,
                lynx: false,
                ethereal: false,
            };
            const totalSpecialCats = 5;
            const specialCatNames = {
                aquatic: 'Mer-cat',
                sphinx: 'Sphinx',
                tiger: 'Pet Tiger',
                lynx: 'Desert Lynx',
                ethereal: 'Ethereal Cat'
            };

            // --- DOM Elements ---
            const storyTextElement = document.getElementById('story-text');
            const choiceButtonsElement = document.getElementById('choice-buttons');
            const catsCollectedElement = document.getElementById('cats-collected');
            const specialCatsCollectedElement = document.getElementById('special-cats-collected');
            const storyFailsElement = document.getElementById('story-fails');
            const specialCatsNamesContainer = document.getElementById('special-cats-names');
            const inventoryContainer = document.getElementById('inventory-container');
            const hintButton = document.getElementById('hint-button');
            const modal = document.getElementById('image-modal');
            const modalImage = document.getElementById('modal-image');
            const modalTitle = document.getElementById('modal-title');
            const modalText = document.getElementById('modal-text');
            const modalContinueButton = document.getElementById('modal-continue-button');

            hintButton.addEventListener('click', () => {
                let hints = "Special Cats Hints:\n\n";
                if (!specialCats.aquatic) hints += hintData.aquatic + "\n";
                if (!specialCats.sphinx) hints += hintData.sphinx + "\n";
                if (!specialCats.tiger) hints += hintData.tiger + "\n";
                if (!specialCats.lynx) hints += hintData.lynx + "\n";
                if (!specialCats.ethereal) hints += hintData.ethereal + "\n";

                if (Object.values(specialCats).every(c => c)) {
                    hints = "You've found all the special cats! Time to go to the convention!";
                }

                showImageModal('Hints', hints, null);
            });

            // --- Game Data (Scenes) ---
            const scenes = {
                start: {
                    text: "Your quest to become the ultimate Cat Collector begins! To find all the cats in the world, you must start somewhere. Do you begin your journey in the bustling city or the tranquil countryside?",
                    choices: [
                        { text: "Head to the bustling city.", nextScene: 'city_start' },
                        { text: "Go to the tranquil countryside.", nextScene: 'countryside_start' }
                    ],
                    action: () => {
                         // Reset all state variables at the start of a new game
                         catsCollected = 0;
                         storyFails = 0;
                         hasDesertLynx = false;
                         hasExoticCat = false;
                         hasVisitedSeaside = false;
                         hasVisitedForest = false;
                         hasVisitedDesert = false;
                         hasCafeClue = false;
                         hasLuckyRod = false;
                         hasPamperedPersian = false;
                         hasGlowingCrystal = false;
                         specialCats = {
                            aquatic: false,
                            sphinx: false,
                            tiger: false,
                            lynx: false,
                            ethereal: false,
                         };
                         updateCatsDisplay();
                         updateSpecialCatsDisplay();
                         updateFailsDisplay();
                         updateInventoryDisplay();
                         updateSpecialCatsList();
                    }
                },
                city_start: {
                    text: "You arrive in the city. The noise is overwhelming, but you're on a mission. Do you visit the famous 'Whisker & Brew' Cat Cafe or attend the exclusive 'Pawsh' Cat Show?",
                    choices: [
                        { text: "Visit the 'Whisker & Brew' Cat Cafe.", nextScene: 'cat_cafe' },
                        { text: "Attend the 'Pawsh' Cat Show.", nextScene: 'cat_show' },
                        { text: "Head out of town.", nextScene: 'crossroads' }
                    ]
                },
                countryside_start: {
                    text: "You find yourself in the serene countryside. Rolling hills and fresh air greet you. Do you explore the mysterious old barn or a friendly, bustling farm?",
                    choices: [
                        { text: "Explore the mysterious old barn.", nextScene: 'mysterious_barn' },
                        { text: "Visit the friendly, bustling farm.", nextScene: 'friendly_farm' },
                        { text: "Seek higher ground.", nextScene: 'crossroads' }
                    ]
                },
                // --- Bad Ending 1: Death ---
                mysterious_barn: {
                    text: "You enter the barn, and the air grows cold. You see a pair of glowing eyes in the darkness. It's a massive, wild bobcat, startled and cornered! Do you try to calm it down or quickly run away?",
                    choices: [
                        { text: "Try to calm it with a soothing voice.", nextScene: 'death_ending' },
                        { text: "Try to tame the bobcat by making yourself big.", nextScene: 'death_ending_big' },
                        { text: "Back away slowly and carefully.", nextScene: 'countryside_start' }
                    ],
                    action: () => {
                        scenes.mysterious_barn.choices = [
                            { text: "Try to calm it with a soothing voice.", nextScene: 'death_ending' },
                            { text: "Try to tame the bobcat by making yourself big.", nextScene: 'death_ending_big' },
                            { text: "Back away slowly and carefully.", nextScene: 'countryside_start' }
                        ];
                        if (hasDesertLynx) {
                            scenes.mysterious_barn.choices.push({ text: "Use your desert lynx to help you tame the bobcat.", nextScene: 'barn_secret' });
                        }
                    }
                },
                death_ending: {
                    text: "The bobcat doesn't appreciate your soothing voice. It lets out a hiss and lunges, and the quest for cats is over. Forever.",
                    choices: [
                        { text: "Restart", nextScene: 'start' },
                        { text: "Undo", nextScene: 'previous' }
                    ],
                    isEnding: true,
                    endingType: 'bad',
                    action: () => {
                         storyFails++;
                         updateFailsDisplay();
                    }
                },
                 death_ending_big: {
                    text: "Your attempt to intimidate the bobcat fails spectacularly. It lets out a furious roar and lunges, and the quest for cats is over. Forever.",
                    choices: [
                        { text: "Restart", nextScene: 'start' },
                        { text: "Undo", nextScene: 'previous' }
                    ],
                    isEnding: true,
                    endingType: 'bad',
                    action: () => {
                         storyFails++;
                         updateFailsDisplay();
                    }
                },
                // --- Bad Ending 2: Incarceration ---
                cat_cafe: {
                    text: "At the cat cafe, a strange person in a trench coat whispers a proposal: 'I know where the legendary Shadow Cat of the West is. It's at a private sanctuary, heavily guarded. Meet me here at midnight, and we'll get it.'",
                    choices: [
                        { text: "Agree to the midnight rendezvous.", nextScene: 'sanctuary_heist' },
                        { text: "Politely decline and stay on the ethical path.", nextScene: 'city_start' },
                        { text: "Talk to other patrons.", nextScene: 'cafe_clue_bonus' }
                    ]
                },
                sanctuary_heist: {
                    text: "You meet the mysterious person and break into the sanctuary. Alarms blare! The person vanishes, and you're caught by the authorities. The judge sentences you to 20 years for attempted cat-napping. No cats for you.",
                    choices: [
                        { text: "Restart", nextScene: 'start' },
                        { text: "Undo", nextScene: 'previous' }
                    ],
                    isEnding: true,
                    endingType: 'bad',
                    action: () => {
                        storyFails++;
                        updateFailsDisplay();
                    }
                },
                // --- Paths to collect cats ---
                cat_show: {
                    text: "You are at the 'Pawsh' Cat Show. What do you want to do?",
                    choices: [
                        // Dynamic choices based on progress
                    ],
                    action: () => {
                        scenes.cat_show.choices = [
                            { text: "Buy a cat.", nextScene: 'cat_show_buy' },
                            { text: "Listen to gossip.", nextScene: 'cat_show_gossip' }
                        ];
                        if (hasExoticCat && !specialCats.tiger) {
                            scenes.cat_show.choices.push({ text: "Enter your exotic cat in a competition.", nextScene: 'tiger_ending' });
                        }
                    }
                },
                cat_show_buy: {
                    text: "You collect a pampered Persian, and get a clue that more rare cats are in a coastal town. You got a cat!",
                    choices: [
                        { text: "Continue the quest.", nextScene: 'crossroads' }
                    ],
                    action: () => {
                        catsCollected++;
                        hasPamperedPersian = true;
                        updateCatsDisplay();
                        updateInventoryDisplay();
                    }
                },
                cat_show_gossip: {
                    text: "You overhear a group of judges talking about the grand Cat Convention, and how all the best collectors are coming with cats from a bustling seaside village.",
                    choices: [
                         { text: "Continue the quest.", nextScene: 'crossroads' }
                    ],
                    action: () => {
                        catsCollected++;
                        updateCatsDisplay();
                    }
                },
                tiger_ending: {
                     text: "Wow! The judges at the Pawsh show are so impressed with your exotic cat, they give you a pet tiger (which counts as a cat) and a reward of $1000!",
                     choices: [
                        { text: "Continue the quest.", nextScene: 'crossroads' }
                    ],
                    action: () => {
                        catsCollected++;
                        specialCats.tiger = true;
                        hasExoticCat = false;
                        updateCatsDisplay();
                        updateSpecialCatsDisplay();
                        updateInventoryDisplay();
                        updateSpecialCatsList();
                        showImageModal('Pet Tiger', 'The judges are wowed by your exotic cat and award you a tiger for winning first place.', imageUrls.tiger);
                    }
                },
                cafe_clue_bonus: {
                    text: "You overhear some patrons talking about a magical cat that lives deep within a mystical forest. This could be a good lead!",
                    choices: [
                        { text: "Return to the city and continue your quest.", nextScene: 'city_start' }
                    ],
                    action: () => {
                        hasCafeClue = true;
                    }
                },
                friendly_farm: {
                    text: "You find yourself at a friendly, bustling farm. The farmer waves at you from his porch. What do you do?",
                    choices: [],
                    action: () => {
                        let choices = [
                            { text: "Ask him about his cousin.", nextScene: 'farm_bad_ending' },
                            { text: "Offer to stack wood.", nextScene: 'farm_good_ending' },
                        ];
                        if (catsCollected >= 5 && !hasLuckyRod) {
                            choices.push({ text: "Offer your cats to catch the mice on his farm.", nextScene: 'farm_rod_ending' });
                        }
                        scenes.friendly_farm.choices = choices;
                    }
                },
                farm_bad_ending: {
                    text: "The farmer gets a scowl on his face. 'I don't know my cousin! Don't be spreading rumors!' he shouts angrily and chases you off his farm.",
                    choices: [
                        { text: "Return to the countryside.", nextScene: 'countryside_start' }
                    ],
                    isEnding: false
                },
                farm_good_ending: {
                    text: "You offer to stack some wood, and the farmer thanks you. He says he's getting too old to care for his cat and gives you the beautiful ginger tabby to look after. You got a cat!",
                    choices: [
                        { text: "Continue the quest.", nextScene: 'crossroads' }
                    ],
                    action: () => {
                        catsCollected++;
                        updateCatsDisplay();
                    }
                },
                farm_rod_ending: {
                    text: "Your cats clear the farm of mice in no time! The farmer is so impressed, he gives you his Lucky Fishing Rod as a thank you.",
                    choices: [
                        { text: "Continue the quest.", nextScene: 'crossroads' }
                    ],
                    action: () => {
                        hasLuckyRod = true;
                        updateInventoryDisplay();
                    }
                },
                crossroads: {
                    text: ``, // The text will be set dynamically in the action function
                    choices: [
                        // Dynamic choices based on progress
                    ],
                    action: () => {
                        scenes.crossroads.text = `You have successfully collected ${catsCollected} cat(s)! You must collect ${totalCats} cats to win. Where do you go next to continue your quest?`;

                        const baseChoices = [
                            { text: "Explore a bustling seaside village.", nextScene: 'seaside_village' },
                            { text: "Venture into a mystical, enchanted forest.", nextScene: 'mystical_forest' },
                            { text: "Travel to a remote desert oasis.", nextScene: 'desert_oasis' }
                        ];

                        const newChoices = [];
                        
                        if (hasVisitedSeaside || hasVisitedForest || hasVisitedDesert) {
                           newChoices.push({ text: "Return to the city.", nextScene: 'city_start'});
                           newChoices.push({ text: "Return to the countryside.", nextScene: 'countryside_start'});
                        }
                        
                        if (hasVisitedSeaside && hasVisitedForest && hasVisitedDesert) {
                            newChoices.push({ text: "Head to the Final Cat Collector's Convention to try and win.", nextScene: 'final_convention' });
                        }

                        scenes.crossroads.choices = [...baseChoices, ...newChoices];
                    }
                },
                seaside_village: {
                    text: "You visit a charming seaside village. You can either visit the docks or the local pet store. Which do you choose?",
                    choices: [
                        { text: "Visit the docks.", nextScene: 'seaside_docks' },
                        { text: "Go to the pet store.", nextScene: 'seaside_pet_store' }
                    ],
                    action: () => {
                        hasVisitedSeaside = true;
                    }
                },
                seaside_docks: {
                    text: "As you approach the docks, you see a grumpy harbor master guarding a pile of fish. Do you offer to help him with his catch, hoping to earn a cat, or sneak around to find some kittens on the fishing boats?",
                    choices: [
                        { text: "Offer to help the harbor master.", nextScene: 'seaside_docks_help' },
                        { text: "Try to sneak onto a boat.", nextScene: 'seaside_docks_sneak' }
                    ],
                    action: () => {
                        scenes.seaside_docks.choices = [
                            { text: "Offer to help the harbor master.", nextScene: 'seaside_docks_help' },
                            { text: "Try to sneak onto a boat.", nextScene: 'seaside_docks_sneak' }
                        ];
                        if (hasLuckyRod && !specialCats.aquatic) {
                            scenes.seaside_docks.choices.push({text: "Use the lucky fishing rod to catch something special.", nextScene: 'docks_fishing_bonus'});
                        }
                    }
                },
                seaside_docks_help: {
                    text: "The harbor master is so grateful for your help that he gives you a whole litter of adorable kittens he found on his boat. You gather three of them and add them to your collection!",
                    choices: [
                        { text: "Return to the crossroads to plan your next move.", nextScene: 'crossroads' }
                    ],
                    action: () => {
                        catsCollected += 3;
                        updateCatsDisplay();
                    }
                },
                seaside_docks_sneak: {
                    text: "You try to sneak onto a boat, but you trip and fall loudly! The harbor master yells at you, and an officer arrests you for trespassing. This quest is over!",
                    choices: [
                        { text: "Restart", nextScene: 'start' },
                        { text: "Undo", nextScene: 'previous' }
                    ],
                    isEnding: true,
                    endingType: 'bad',
                    action: () => {
                         storyFails++;
                         updateFailsDisplay();
                    }
                },
                docks_fishing_bonus: {
                    text: "You cast your lucky fishing rod and pull in not a fish, but a rare, aquatic feline with shimmering scales! It happily joins your collection.",
                    choices: [
                         { text: "Return to the crossroads to plan your next move.", nextScene: 'crossroads' }
                    ],
                    action: () => {
                        catsCollected += 1;
                        hasLuckyRod = false;
                        specialCats.aquatic = true;
                        updateCatsDisplay();
                        updateSpecialCatsDisplay();
                        updateInventoryDisplay();
                        updateSpecialCatsList();
                        showImageModal('Mer-cat', 'You found a rare mer-cat with shimmering scales!', imageUrls.aquatic);
                    }
                },
                seaside_pet_store: {
                    text: "You find a rare, exotic feline at the pet store. With a bit of convincing, you are able to adopt the unique cat.",
                    choices: [
                        { text: "Return to the crossroads to plan your next move.", nextScene: 'crossroads' }
                    ],
                    action: () => {
                        catsCollected += 1;
                        hasExoticCat = true;
                        updateCatsDisplay();
                        updateInventoryDisplay();
                    }
                },
                mystical_forest: {
                    text: "Deep in the forest, you encounter two paths. One is a sparkling path that leads to a magical grove, and the other is a shadowy trail leading to a mysterious cave. Which path do you choose?",
                    choices: [
                        { text: "Take the sparkling path.", nextScene: 'mystical_grove' },
                        { text: "Follow the shadowy trail.", nextScene: 'mystical_cave' }
                    ],
                    action: () => {
                        hasVisitedForest = true;
                    }
                },
                mystical_grove: {
                    text: "You follow the sparkling path and find yourself in a beautiful, open grove. You can either charm the fairies for cats, or you can find a way to enter a hidden, magical glade.",
                    choices: [
                        { text: "Try to charm the fairies.", nextScene: 'mystical_grove_fairies' },
                        { text: "Find the hidden glade.", nextScene: 'mystical_grove_glade' }
                    ],
                    action: () => {
                        scenes.mystical_grove.choices = [
                            { text: "Try to charm the fairies.", nextScene: 'mystical_grove_fairies' },
                            { text: "Find the hidden glade.", nextScene: 'mystical_grove_glade' }
                        ];
                        if (hasCafeClue && !specialCats.sphinx) {
                            scenes.mystical_grove.choices.push({ text: "Follow the rumor you heard at the cafe.", nextScene: 'forest_clue_bonus' });
                        }
                    }
                },
                mystical_grove_fairies: {
                    text: "In the magical grove, a wise, ancient cat grants you two companions for your quest, after you share some of your snacks with the fairies.",
                    choices: [
                        { text: "Return to the crossroads to plan your next move.", nextScene: 'crossroads' }
                    ],
                    action: () => {
                        catsCollected += 2;
                        updateCatsDisplay();
                    }
                },
                mystical_grove_glade: {
                    text: "You find a hidden glade, but you are caught by the glade's guardian, a wise old owl. The owl is angry you are trespassing and casts a spell on you, turning you into a mouse. Your quest is over!",
                    choices: [
                        { text: "Restart", nextScene: 'start' },
                        { text: "Undo", nextScene: 'previous' }
                    ],
                    isEnding: true,
                    endingType: 'bad',
                    action: () => {
                         storyFails++;
                         updateFailsDisplay();
                    }
                },
                forest_clue_bonus: {
                    text: "You follow the trail from the cafe clue and find a tiny, glowing Sphinx.",
                    choices: [
                         { text: "Speak the answer to the riddle.", nextScene: 'sphinx_riddle' }
                    ],
                    action: () => {
                        
                    }
                },
                sphinx_riddle: {
                    text: "I have cities, but no houses. I have mountains, but no trees. I have water, but no fish. What am I?",
                    choices: [
                        { text: "America.", nextScene: 'teleport_ending' },
                        { text: "A map.", nextScene: 'sphinx_success' },
                        { text: "A book.", nextScene: 'teleport_ending' },
                        { text: "The sky.", nextScene: 'teleport_ending' },
                    ]
                },
                sphinx_success: {
                    text: "You answer correctly, and the Sphinx purrs with delight! It happily joins your collection as a reward for your wisdom.",
                    choices: [
                        { text: "Return to the crossroads to plan your next move.", nextScene: 'crossroads' }
                    ],
                    action: () => {
                        catsCollected += 1;
                        specialCats.sphinx = true;
                        updateCatsDisplay();
                        updateSpecialCatsDisplay();
                        updateSpecialCatsList();
                        showImageModal('Sphinx', 'You have solved the riddle and gained the wise Sphinx!', imageUrls.sphinx);
                    }
                },
                teleport_ending: {
                    text: "Your answer angers the Sphinx! With a flash of light, it teleports you to a random area of the world. Your quest continues, but you are disoriented.",
                    choices: [
                         { text: "Continue the quest.", nextScene: 'crossroads' }
                    ],
                    isEnding: false,
                    action: () => {
                         storyFails++;
                         updateFailsDisplay();
                    }
                },
                mystical_cave: {
                    text: "You follow the shadowy trail and find yourself at the entrance of a mysterious cave. What do you do?",
                    choices: [
                        { text: "Enter the cave.", nextScene: 'cave_enter' },
                        { text: "Climb the rocky slope.", nextScene: 'cave_fall_ending' },
                        { text: "Return to crossroads.", nextScene: 'crossroads' }
                    ],
                    action: () => {
                        scenes.mystical_cave.choices = [
                            { text: "Enter the cave.", nextScene: 'cave_enter' },
                            { text: "Climb the rocky slope.", nextScene: 'cave_fall_ending' },
                            { text: "Return to crossroads.", nextScene: 'crossroads' }
                        ];
                        if (hasGlowingCrystal && !specialCats.ethereal) {
                           scenes.mystical_cave.choices.push({ text: "Use your crystal to find something special.", nextScene: 'mystical_cave_bonus' });
                        }
                    }
                },
                cave_enter: {
                    text: "In the cave, a mischievous fairy leads you to a treasure trove guarded by two fierce-looking cats. You bravely fight them and collect the cats as a reward.",
                    choices: [
                        { text: "Return to the crossroads to plan your next move.", nextScene: 'crossroads' }
                    ],
                    action: () => {
                        catsCollected += 2;
                        updateCatsDisplay();
                    }
                },
                cave_fall_ending: {
                    text: "You attempt to climb the rocky slope, but your footing gives way. You fall and end up in a coma. Your quest is over.",
                    choices: [
                        { text: "Restart", nextScene: 'start' },
                        { text: "Undo", nextScene: 'previous' }
                    ],
                    isEnding: true,
                    endingType: 'bad',
                    action: () => {
                         storyFails++;
                         updateFailsDisplay();
                    }
                },
                mystical_cave_bonus: {
                    text: "You use your crystal to open a secret chamber. Inside the walls pulsate with ancient light. A tiny, luminous cat with shimmering wings takes flight from it and joins your collection.",
                    choices: [
                        { text: "Return to the crossroads to plan your next move.", nextScene: 'crossroads' }
                    ],
                    action: () => {
                        catsCollected += 1;
                        hasGlowingCrystal = false;
                        specialCats.ethereal = true;
                        updateCatsDisplay();
                        updateSpecialCatsDisplay();
                        updateInventoryDisplay();
                        updateSpecialCatsList();
                        showImageModal('Ethereal Cat', 'You discovered a tiny, luminous cat with shimmering wings!', imageUrls.ethereal);
                    }
                },
                desert_oasis: {
                    text: "In the desert, you discover a hidden oasis. The felines here are elusive. What do you do?",
                    choices: [],
                    action: () => {
                        hasVisitedDesert = true;
                        const choices = [
                            { text: "Set a trap.", nextScene: 'oasis_trap' },
                            { text: "Explore the ancient ruins.", nextScene: 'ruins_trap' },
                            { text: "Look for water.", nextScene: 'oasis_shrine' }
                        ];
                        if (hasPamperedPersian && !specialCats.lynx) {
                            choices.push({ text: "Wait patiently and pamper your persian with pats.", nextScene: 'oasis_patience' });
                        }
                        scenes.desert_oasis.choices = choices;
                    }
                },
                oasis_shrine: {
                    text: "While searching for water, you discover a hidden shrine. Inside, a beautiful glowing crystal is revealed. You take the crystal and hope it will aid you on your journey.",
                    choices: [
                        { text: "Return to the crossroads to plan your next move.", nextScene: 'crossroads' }
                    ],
                    action: () => {
                        hasGlowingCrystal = true;
                        updateInventoryDisplay();
                        showImageModal('Glowing Crystal', 'You found a glowing crystal that might be useful!', imageUrls.GlowingCrystal);
                    }
                },
                ruins_trap: {
                    text: "You explore the ancient ruins, but you set off a booby trap! A giant boulder rolls down a narrow path and traps you. You are stuck, and your quest is over.",
                    choices: [
                        { text: "Restart", nextScene: 'start' },
                        { text: "Undo", nextScene: 'previous' }
                    ],
                    isEnding: true,
                    endingType: 'bad',
                    action: () => {
                         storyFails++;
                         updateFailsDisplay();
                    }
                },
                oasis_patience: {
                    text: "You sit patiently, and your pampered persian's purrs echo through the oasis. A beautiful desert lynx approaches, intrigued by the gentle sound. It is impressed by your patience and joins your collection.",
                    choices: [
                        { text: "Return to the crossroads to plan your next move.", nextScene: 'crossroads' }
                    ],
                    action: () => {
                        catsCollected += 1;
                        hasDesertLynx = true;
                        hasPamperedPersian = false;
                        specialCats.lynx = true;
                        updateCatsDisplay();
                        updateSpecialCatsDisplay();
                        updateInventoryDisplay();
                        updateSpecialCatsList();
                        showImageModal('Desert Lynx', 'The majestic desert lynx has joined your collection!', imageUrls.lynx);
                    }
                },
                oasis_trap: {
                    text: "You set a clever trap, but you accidentally trip and get the trap stuck around your ankle. You are now stranded in the desert, unable to continue your quest.",
                    choices: [
                        { text: "Restart", nextScene: 'start' },
                        { text: "Undo", nextScene: 'previous' }
                    ],
                    isEnding: true,
                    endingType: 'bad',
                    action: () => {
                         storyFails++;
                         updateFailsDisplay();
                    }
                },
                // --- Final challenge scene with win/lose logic ---
                final_convention: {
                    text: "You arrive at the grand convention. The judges stand before you, ready to count your collection.",
                    choices: [
                        { text: "Present your cats to the judges!" }
                    ],
                    action: () => {
                        const sceneId = catsCollected >= totalCats ? 'success_ending' : 'failure_ending';
                        updateScene(sceneId);
                    }
                },
                // --- Successful Ending ---
                success_ending: {
                    text: ``,
                    choices: [
                        { text: "Restart", nextScene: 'start' },
                        { text: "Undo", nextScene: 'previous' }
                    ],
                    isEnding: true,
                    endingType: 'success'
                },
                // --- Bad Ending 3: Failure ---
                failure_ending: {
                    text: ``,
                    choices: [
                        { text: "Restart", nextScene: 'start' },
                        { text: "Undo", nextScene: 'previous' }
                    ],
                    isEnding: true,
                    endingType: 'bad',
                    action: () => {
                         storyFails++;
                         updateFailsDisplay();
                    }
                },
                // --- Secret Ending ---
                barn_secret: {
                    text: "The desert lynx you collected helps you approach the bobcat. The lynx whispers words of encouragement to the bobcat, and it calms down, revealing it is the guardian of a secret feline paradise. The bobcat leads you to a hidden door, and inside, you find a massive, sprawling room filled with 1000 cats. You bring them all to the judges.",
                    choices: [
                        { text: "Present your 1000 cats!", nextScene: 'secret_ending' }
                    ],
                    action: () => {
                        catsCollected += 1000;
                        updateCatsDisplay();
                    }
                },
                secret_ending: {
                    text: "Wow, 1000 cats! The judges are astonished. You are the new cat master. The ultimate feline queen.",
                    choices: [
                        { text: "Restart", nextScene: 'start' },
                        { text: "Undo", nextScene: 'mysterious_barn' }
                    ],
                    isEnding: true,
                    endingType: 'secret'
                }
            };

            // --- Core Game Functions ---

            function showImageModal(title, text, imageUrl) {
                modalTitle.textContent = title;
                modalText.textContent = text;
                modalImage.src = imageUrl || '';
                modal.style.display = 'flex';

                modalContinueButton.onclick = () => {
                    modal.style.display = 'none';
                };
            }

            function updateScene(sceneId) {
                previousState = currentState;
                currentState = sceneId;

                const scene = scenes[sceneId];

                if (sceneId === 'success_ending') {
                    scene.text = `Congratulations! You have collected ${catsCollected} cats, which is more than the required ${totalCats}. The judges are impressed! You are crowned the ultimate Cat Collector.`;
                } else if (sceneId === 'failure_ending') {
                    scene.text = `The judges count your cats... You only have ${catsCollected}. This is not enough! They declare your quest a failure. You return home in shame, but with some new cat friends.`;
                } else if (sceneId === 'crossroads') {
                     scene.text = `You have successfully collected ${catsCollected} cat(s)! You must collect ${totalCats} cats to win. Where do you go next to continue your quest?`;
                }

                choiceButtonsElement.innerHTML = '';
                storyTextElement.classList.add('fade-in');

                if (scene.action) {
                    scene.action();
                }

                setTimeout(() => {
                    storyTextElement.innerHTML = scene.text;
                    storyTextElement.classList.remove('fade-in');
                }, 100);

                scene.choices.forEach(choice => {
                    const button = document.createElement('button');
                    button.textContent = choice.text;
                    
                    if (choice.nextScene === 'final_convention') {
                        button.addEventListener('click', () => {
                            if (catsCollected >= totalCats) {
                                updateScene('success_ending');
                            } else {
                                updateScene('failure_ending');
                            }
                        });
                    } else if (choice.nextScene === 'secret_ending') {
                        button.addEventListener('click', () => {
                            updateScene('secret_ending');
                        });
                    } else if (choice.nextScene === 'previous') {
                         button.addEventListener('click', () => {
                             updateScene(previousState);
                         });
                         button.classList.add('undo-button');
                    } else if (choice.nextScene === 'start') {
                        button.addEventListener('click', () => {
                            updateScene(choice.nextScene);
                        });
                        button.classList.add('restart-button');
                    }
                    else {
                        button.addEventListener('click', () => {
                            updateScene(choice.nextScene);
                        });
                    }
                    
                    if (choice.nextScene === 'farm_bad_ending' || choice.nextScene === 'death_ending' || choice.nextScene === 'death_ending_big' || choice.nextScene === 'sanctuary_heist' || choice.nextScene === 'mystical_grove_glade' || choice.nextScene === 'ruins_trap' || choice.nextScene === 'oasis_trap') {
                        button.classList.add('bad-ending-button');
                    }
                     if (scene.isEnding) {
                        if (scene.endingType === 'success') {
                            button.classList.add('success-ending-button');
                        } else if (choice.nextScene === 'previous') {
                            button.classList.add('undo-button');
                        } else if (choice.text === 'Return to the countryside.') {
                             // This is not an ending so we don't apply ending button styles
                        } else if (choice.text === 'Return to the city.') {
                             // This is not an ending so we don't apply ending button styles
                        } else if (scene.endingType === 'bad' && choice.nextScene === 'start') {
                            button.classList.add('restart-button');
                        } else if (scene.endingType === 'secret') {
                            button.classList.add('secret-ending-button');
                        }
                    }
                    choiceButtonsElement.appendChild(button);
                });
            }

            function updateCatsDisplay() {
                catsCollectedElement.textContent = `Cats Collected: ${catsCollected} / ${totalCats}`;
                if (catsCollected >= totalCats) {
                    catsCollectedElement.style.color = '#22c55e';
                    catsCollectedElement.style.fontWeight = 'bold';
                } else {
                    catsCollectedElement.style.color = '#4a5568';
                    catsCollectedElement.style.fontWeight = 'normal';
                }
            }

            function updateSpecialCatsDisplay() {
                const collectedCount = Object.values(specialCats).filter(v => v).length;
                specialCatsCollectedElement.textContent = `Special Cats: ${collectedCount} / ${totalSpecialCats}`;
                if (collectedCount === totalSpecialCats) {
                    specialCatsCollectedElement.style.color = '#22c55e';
                    specialCatsCollectedElement.style.fontWeight = 'bold';
                } else {
                    specialCatsCollectedElement.style.color = '#4a5568';
                    specialCatsCollectedElement.style.fontWeight = 'normal';
                }
            }

            function updateFailsDisplay() {
                storyFailsElement.textContent = `Fails: ${storyFails}`;
            }

            function updateInventoryDisplay() {
                const inventoryItems = [
                    { id: 'item-rod', label: 'Lucky Rod', has: hasLuckyRod },
                    { id: 'item-persian', label: 'Pampered Persian', has: hasPamperedPersian },
                    { id: 'item-crystal', label: 'Glowing Crystal', has: hasGlowingCrystal },
                    { id: 'item-exotic', label: 'Exotic Cat', has: hasExoticCat }
                ];
                inventoryItems.forEach(item => {
                    const element = document.getElementById(item.id);
                    if (element) {
                        element.classList.toggle('hidden', !item.has);
                    }
                });
            }

            function updateSpecialCatsList() {
                specialCatsNamesContainer.innerHTML = '';
                Object.keys(specialCats).forEach(catKey => {
                    if (specialCats[catKey]) {
                        const catName = document.createElement('span');
                        catName.classList.add('inventory-item', 'font-bold');
                        catName.textContent = specialCatNames[catKey];
                        specialCatsNamesContainer.appendChild(catName);
                    }
                });
            }

            updateScene('start');
        })();
    </script>
</body>
</html>
